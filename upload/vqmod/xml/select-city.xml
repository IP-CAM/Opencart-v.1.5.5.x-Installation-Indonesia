<modification>
	<id>Select City</id>
	<version>1.0.0</version>
	<vqmver>2.3.2</vqmver>
	<author>http://www.opencart-id.com/</author>

	<file name="admin/controller/common/header.php">
		<operation info="Insert City menu in admin">
			<search position="after"><![CDATA[
			$this->data['zone'] = $this->url->link('localisation/zone', 'token=' . $this->session->data['token'], 'SSL');
			]]></search>
			<add><![CDATA[
			$this->data['text_city'] = $this->language->get('text_city');
			$this->data['city'] = $this->url->link('localisation/city', 'token=' . $this->session->data['token'], 'SSL');
			]]></add>
		</operation>
	</file>

	<file name="admin/view/template/common/header.tpl">
		<operation info="Insert City menu in admin">
			<search position="after"><![CDATA[
			  <li><a href="<?php echo $zone; ?>"><?php echo $text_zone; ?></a></li>
			]]></search>
			<add><![CDATA[
			  <li><a href="<?php echo $city; ?>"><?php echo $text_city; ?></a></li>
			]]></add>
		</operation>
	</file>

	<file name="admin/language/english/common/header.php">
		<operation info="Insert City menu in admin">
			<search position="before"><![CDATA[
?>
			]]></search>
			<add><![CDATA[
$_['text_city']						= 'Cities';
			]]></add>
		</operation>
	</file>

	<file name="admin/controller/sale/customer.php">
		<operation info="Add AJAX Response">
			<search position="before"><![CDATA[
	public function address() {
			]]></search>
			<add><![CDATA[
	public function zone() {
		$json = array();

		$this->load->model('localisation/zone');

		$zone_info = $this->model_localisation_zone->getZone($this->request->get['zone_id']);

		if ($zone_info) {
			$this->load->model('localisation/city');

			$json = array(
				'zone_id'	=> $zone_info['zone_id'],
				'name'		=> $zone_info['name'],
				'city'		=> $this->model_localisation_city->getCitiesByZoneId($this->request->get['zone_id']),
				'status'	=> $zone_info['status']
			);
		}

		$this->response->setOutput(json_encode($json));
	}
			]]></add>
		</operation>
	</file>

	<file name="admin/view/template/sale/customer_form.tpl">
		<operation info="Remove city field">
			<search position="replace" offset="8"><![CDATA[
				<td><input type="text" name="address[<?php echo $address_row; ?>][address_2]" value="<?php echo $address['address_2']; ?>" /></td>
			]]></search>
			<add><![CDATA[
				<td><input type="text" name="address[<?php echo $address_row; ?>][address_2]" value="<?php echo $address['address_2']; ?>" /></td>
			  </tr>
			]]></add>
		</operation>

		<operation info="Change city text field to select and place it after zone">
			<search position="after" offset="2"><![CDATA[
				  <span class="error"><?php echo $error_address_zone[$address_row]; ?></span>
			]]></search>
			<add><![CDATA[
			  <tr>
				<td><span class="required">*</span> <?php echo $entry_city; ?></td>
				<td><select name="address[<?php echo $address_row; ?>][city]"><option value=""><?php echo $text_select; ?></option></select>
				  <?php if (isset($error_address_city[$address_row])) { ?>
				  <span class="error"><?php echo $error_address_city[$address_row]; ?></span>
				  <?php } ?></td>
			  </tr>
			]]></add>
		</operation>

		<operation info="Add onchange attribute in zone select">
			<search position="replace"><![CDATA[
				<td><select name="address[<?php echo $address_row; ?>][zone_id]">
			]]></search>
			<add><![CDATA[
				<td><select name="address[<?php echo $address_row; ?>][zone_id]"onchange="zone(this, '<?php echo $address_row; ?>', '<?php echo $address['city']; ?>');">
			]]></add>
		</operation>

		<operation info="Call zone function after country function is triggered">
			<search position="after"><![CDATA[
				$('select[name=\'address[' + index + '][zone_id]\']').html(html);
			]]></search>
			<add><![CDATA[
				$('select[name$=\'[zone_id]\']').trigger('change');
			]]></add>
		</operation>

		<operation info="Add AJAX change city based on selected zone">
			<search position="after" offset="1"><![CDATA[
$('select[name$=\'[country_id]\']').trigger('change');
			]]></search>
			<add><![CDATA[
<script type="text/javascript"><!--
function zone(element, index, city) {
  if (element.value != '') {
		$.ajax({
			url: 'index.php?route=sale/customer/zone&token=<?php echo $token; ?>&zone_id=' + element.value,
			dataType: 'json',
			beforeSend: function() {
				$('select[name=\'address[' + index + '][zone_id]\']').after('<span class="wait">&nbsp;<img src="view/image/loading.gif" alt="" /></span>');
			},
			complete: function() {
				$('.wait').remove();
			},
			success: function(json) {
				html = '<option value=""><?php echo $text_select; ?></option>';

				if (json['city'] != '') {
					for (i = 0; i < json['city'].length; i++) {
						html += '<option value="' + json['city'][i]['name'] + '"';

						if (json['city'][i]['name'] == city) {
							html += ' selected="selected"';
						}

						html += '>' + json['city'][i]['name'] + '</option>';
					}
				} else {
					html += '<option value="0"><?php echo $text_none; ?></option>';
				}

				$('select[name=\'address[' + index + '][city]\']').html(html);
			},
			error: function(xhr, ajaxOptions, thrownError) {
				alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			}
		});
	}
}

$('select[name$=\'[zone_id]\']').trigger('change');
//--></script>
			]]></add>
		</operation>
	</file>

	<file path="catalog/controller/" name="account/address.php,account/register.php,affiliate/edit.php,affiliate/register.php">
		<operation info="Get cities data">
			<search position="before"><![CDATA[
		if (isset($this->request->post['city'])) {
			]]></search>
			<add><![CDATA[
		$this->load->model('localisation/city');

		$this->data['cities'] = $this->model_localisation_city->getCities();
			]]></add>
		</operation>

		<operation info="Add AJAX response">
			<search position="before" offset="1"><![CDATA[
?>
			]]></search>
			<add><![CDATA[
	public function zone() {
		$json = array();

		$this->load->model('localisation/zone');

		$zone_info = $this->model_localisation_zone->getZone($this->request->get['zone_id']);

		if ($zone_info) {
			$this->load->model('localisation/city');

			$json = array(
				'zone_id'	=> $zone_info['zone_id'],
				'name'		=> $zone_info['name'],
				'city'		=> $this->model_localisation_city->getCitiesByZoneId($this->request->get['zone_id']),
				'status'	=> $zone_info['status']
			);
		}

		$this->response->setOutput(json_encode($json));
	}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/guest.php">
		<operation info="Get payment cities data">
			<search position="before"><![CDATA[
		if (isset($this->session->data['guest']['payment']['city'])) {
			]]></search>
			<add><![CDATA[
		$this->load->model('localisation/city');

		$this->data['cities'] = $this->model_localisation_city->getCities();
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/guest_shipping.php">
		<operation info="Get shipping cities data">
			<search position="before"><![CDATA[
		if (isset($this->session->data['guest']['shipping']['city'])) {
			]]></search>
			<add><![CDATA[
		$this->load->model('localisation/city');

		$this->data['cities'] = $this->model_localisation_city->getCities();
			]]></add>
		</operation>
	</file>

	<file path="catalog/controller/checkout/" name="payment_address.php,register.php,shipping_address.php">
		<operation info="Get payment cities data">
			<search position="before" index="1"><![CDATA[
		$this->load->model('localisation/country');
			]]></search>
			<add><![CDATA[
		$this->load->model('localisation/city');

		$this->data['cities'] = $this->model_localisation_city->getCities();
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/checkout.php">
		<operation info="Add AJAX response">
			<search position="before" offset="1"><![CDATA[
?>
			]]></search>
			<add><![CDATA[
	public function zone() {
		$json = array();

		$this->load->model('localisation/zone');

		$zone_info = $this->model_localisation_zone->getZone($this->request->get['zone_id']);

		if ($zone_info) {
			$this->load->model('localisation/city');

			$json = array(
				'zone_id'	=> $zone_info['zone_id'],
				'name'		=> $zone_info['name'],
				'city'		=> $this->model_localisation_city->getCitiesByZoneId($this->request->get['zone_id']),
				'status'	=> $zone_info['status']
			);
		}

		$this->response->setOutput(json_encode($json));
	}
			]]></add>
		</operation>
	</file>

	<file path="catalog/language/english/" name="account/address.php,account/register.php,affiliate/edit.php,affiliate/register.php,checkout/checkout.php">
		<operation info="Change city error message">
			<search position="replace"><![CDATA[
City must be between 2 and 128 characters!
			]]></search>
			<add><![CDATA[
Please select a city!
			]]></add>
		</operation>
	</file>

	<file path="catalog/view/theme/default/template/" name="account/address_form.tpl,account/register.tpl,affiliate/edit.tpl,affiliate/register.tpl">
		<operation info="Remove city field">
			<search position="replace" offset="8"><![CDATA[
		  <td><input type="text" name="address_2" value="<?php echo $address_2; ?>" /></td>
			]]></search>
			<add><![CDATA[
		  <td><input type="text" name="address_2" value="<?php echo $address_2; ?>" /></td>
		</tr>
			]]></add>
		</operation>

		<operation info="Change city text field to select and place it after zone">
			<search position="after" offset="2"><![CDATA[
			<span class="error"><?php echo $error_zone; ?></span>
			]]></search>
			<add><![CDATA[
		<tr>
		  <td><span class="required">*</span> <?php echo $entry_city; ?></td>
		  <td><select name="city"><option value=""><?php echo $text_select; ?></option></select>
			<?php if ($error_city) { ?>
			<span class="error"><?php echo $error_city; ?></span>
			<?php } ?>
		  </td>
		</tr>
			]]></add>
		</operation>

		<operation info="Add AJAX change city based on selected zone">
			<search position="before"><![CDATA[
<?php echo $footer; ?>
			]]></search>
			<add><![CDATA[
<script type="text/javascript"><!--
$('select[name=\'zone_id\']').bind('change', function() {
	if (this.value == '') return;
	$.ajax({
		url: 'index.php?route=account/register/zone&zone_id=' + this.value,
		dataType: 'json',
		beforeSend: function() {
			$('select[name=\'zone_id\']').after('<span class="wait">&nbsp;<img src="catalog/view/theme/default/image/loading.gif" alt="" /></span>');
		},
		complete: function() {
			$('.wait').remove();
		},
		success: function(json) {
			html = '<option value=""><?php echo $text_select; ?></option>';

			if (json['city'] != '') {
				for (i = 0; i < json['city'].length; i++) {
					html += '<option value="' + json['city'][i]['name'] + '"';

					if (json['city'][i]['name'] == '<?php echo $city; ?>') {
		  				html += ' selected="selected"';
					}

					html += '>' + json['city'][i]['name'] + '</option>';
				}
			} else {
				html += '<option value="0" selected="selected"><?php echo $text_none; ?></option>';
			}

			$('select[name=\'city\']').html(html);
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
});

$('select[name=\'zone_id\']').trigger('change');
//--></script>
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/default/template/checkout/guest.tpl">
		<operation info="Remove city field">
			<search position="replace" offset="4"><![CDATA[
  <input type="text" name="address_2" value="<?php echo $address_2; ?>" class="large-field" />
			]]></search>
			<add><![CDATA[
  <input type="text" name="address_2" value="<?php echo $address_2; ?>" class="large-field" />
			]]></add>
		</operation>

		<operation info="Change city text field to select and place it after zone">
			<search position="after" offset="1"><![CDATA[
  <select name="zone_id" class="large-field">
			]]></search>
			<add><![CDATA[
  <br />
  <br />
  <select name="city" class="large-field"><option value=""><?php echo $text_select; ?></option></select>
			]]></add>
		</operation>
	</file>

	<file path="catalog/view/theme/default/template/checkout/" name="guest.tpl,payment_address.tpl,register.tpl">
		<operation info="Add AJAX change city based on selected zone">
			<search position="after" offset="1"><![CDATA[
$('#payment-address select[name=\'country_id\']').trigger('change');
			]]></search>
			<add><![CDATA[
<script type="text/javascript"><!--
$('#payment-address select[name=\'zone_id\']').bind('change', function() {
	if (this.value == '') return;
	$.ajax({
		url: 'index.php?route=checkout/checkout/zone&zone_id=' + this.value,
		dataType: 'json',
		beforeSend: function() {
			$('#payment-address select[name=\'zone_id\']').after('<span class="wait">&nbsp;<img src="catalog/view/theme/default/image/loading.gif" alt="" /></span>');
		},
		complete: function() {
			$('.wait').remove();
		},
		success: function(json) {
			html = '<option value=""><?php echo $text_select; ?></option>';

			if (json['city'] != '') {
				for (i = 0; i < json['city'].length; i++) {
					html += '<option value="' + json['city'][i]['name'] + '">' + json['city'][i]['name'] + '</option>';
				}
			} else {
				html += '<option value="0" selected="selected"><?php echo $text_none; ?></option>';
			}

			$('#payment-address select[name=\'city\']').html(html);
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
});

$('#payment-address select[name=\'zone_id\']').trigger('change');
//--></script>
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/default/template/checkout/guest_shipping.tpl">
		<operation info="Remove city field">
			<search position="replace" offset="5"><![CDATA[
	<td><input type="text" name="address_2" value="<?php echo $address_2; ?>" class="large-field" /></td>
			]]></search>
			<add><![CDATA[
	<td><input type="text" name="address_2" value="<?php echo $address_2; ?>" class="large-field" /></td>
  </tr>
			]]></add>
		</operation>

		<operation info="Change city text field to select and place it after zone">
			<search position="after" offset="2"><![CDATA[
	<td><select name="zone_id" class="large-field">
			]]></search>
			<add><![CDATA[
  <tr>
	<td><span class="required">*</span> <?php echo $entry_city; ?></td>
	<td><select name="city" class="large-field"><option value=""><?php echo $text_select; ?></option></select></td>
  </tr>
			]]></add>
		</operation>
	</file>

	<file path="catalog/view/theme/default/template/checkout/" name="guest_shipping.tpl,shipping_address.tpl">
		<operation info="Add AJAX change city based on selected zone">
			<search position="after" offset="1"><![CDATA[
$('#shipping-address select[name=\'country_id\']').trigger('change');
			]]></search>
			<add><![CDATA[
<script type="text/javascript"><!--
$('#shipping-address select[name=\'zone_id\']').bind('change', function() {
	if (this.value == '') return;
	$.ajax({
		url: 'index.php?route=checkout/checkout/zone&zone_id=' + this.value,
		dataType: 'json',
		beforeSend: function() {
			$('#shipping-address select[name=\'zone_id\']').after('<span class="wait">&nbsp;<img src="catalog/view/theme/default/image/loading.gif" alt="" /></span>');
		},
		complete: function() {
			$('.wait').remove();
		},
		success: function(json) {
			html = '<option value=""><?php echo $text_select; ?></option>';

			if (json['city'] != '') {
				for (i = 0; i < json['city'].length; i++) {
					html += '<option value="' + json['city'][i]['name'] + '"';

					if (json['city'][i]['name'] == '<?php echo $city; ?>') {
		  				html += ' selected="selected"';
					}

					html += '>' + json['city'][i]['name'] + '</option>';
				}
			} else {
				html += '<option value="0" selected="selected"><?php echo $text_none; ?></option>';
			}

			$('#shipping-address select[name=\'city\']').html(html);
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
});

$('#shipping-address select[name=\'zone_id\']').trigger('change');
//--></script>
			]]></add>
		</operation>
	</file>

	<file path="catalog/view/theme/default/template/checkout/" name="payment_address.tpl,shipping_address.tpl">
		<operation info="Remove city field">
			<search position="replace" offset="5"><![CDATA[
	  <td><input type="text" name="address_2" value="" class="large-field" /></td>
			]]></search>
			<add><![CDATA[
	  <td><input type="text" name="address_2" value="" class="large-field" /></td>
	</tr>
			]]></add>
		</operation>

		<operation info="Change city text field to select and place it after zone">
			<search position="after" offset="2"><![CDATA[
	  <td><select name="zone_id" class="large-field">
			]]></search>
			<add><![CDATA[
	<tr>
	  <td><span class="required">*</span> <?php echo $entry_city; ?></td>
	  <td><select name="city" class="large-field"><option value=""><?php echo $text_select; ?></option></select></td>
	</tr>
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/default/template/checkout/register.tpl">
		<operation info="Remove city field">
			<search position="replace" offset="4"><![CDATA[
<input type="text" name="address_2" value="" class="large-field" />
			]]></search>
			<add><![CDATA[
<input type="text" name="address_2" value="" class="large-field" />
			]]></add>
		</operation>

		<operation info="Change city text field to select and place it after zone">
			<search position="after" offset="1"><![CDATA[
<select name="zone_id" class="large-field">
			]]></search>
			<add><![CDATA[
<br />
<br />
<span class="required">*</span> <?php echo $entry_city; ?><br />
<select name="city" class="large-field"><option value=""><?php echo $text_select; ?></option></select>
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/default/template/checkout/checkout.tpl">
		<operation info="Change city error message">
			<search position="replace"><![CDATA[
					$('#payment-address input[name=\'city\']').after('<span class="error">' + json['error']['city'] + '</span>');
			]]></search>
			<add><![CDATA[
					$('#payment-address select[name=\'city\']').after('<span class="error">' + json['error']['city'] + '</span>');
			]]></add>
		</operation>

		<operation info="Change city error message">
			<search position="replace"><![CDATA[
					$('#shipping-address input[name=\'city\']').after('<span class="error">' + json['error']['city'] + '</span>');
			]]></search>
			<add><![CDATA[
					$('#shipping-address select[name=\'city\']').after('<span class="error">' + json['error']['city'] + '</span>');
			]]></add>
		</operation>

		<operation info="Change city error message">
			<search position="replace"><![CDATA[
					$('#payment-address input[name=\'city\'] + br').after('<span class="error">' + json['error']['city'] + '</span>');
			]]></search>
			<add><![CDATA[
					$('#payment-address select[name=\'city\'] + br').after('<span class="error">' + json['error']['city'] + '</span>');
			]]></add>
		</operation>
	</file>
</modification>